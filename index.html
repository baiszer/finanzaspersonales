<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Finanzas personales</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="theme-color" content="#0f172a" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <meta name="apple-mobile-web-app-title" content="Finanzas" />
  <link rel="manifest" href="manifest.webmanifest" />
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif; }
    body { background: #0f172a; color: #e5e7eb; padding: 24px; }
    h1 { text-align: center; margin-bottom: 24px; font-size: 2rem; color: #f9fafb; }
    .container { max-width: 1200px; margin: 0 auto; }

    .summary {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      gap: 16px;
      margin-bottom: 16px;
    }
    .summary-card {
      background: rgba(15,23,42,0.9);
      border-radius: 14px;
      padding: 12px 14px;
      border: 1px solid rgba(148,163,184,0.35);
    }
    .summary-label {
      font-size: 0.75rem;
      text-transform: uppercase;
      letter-spacing: .06em;
      color: #9ca3af;
      margin-bottom: 4px;
    }
    .summary-value {
      font-size: 1.05rem;
      font-weight: 600;
    }
    .summary-value.pos { color: #4ade80; }
    .summary-value.neg { color: #fb923c; }
    .summary-value.neutro { color: #e5e7eb; }
    .btn-export {
      margin-top: 6px;
      background: transparent;
      border: 1px solid #38bdf8;
      color: #e0f2fe;
      padding: 7px 12px;
      border-radius: 999px;
      font-size: 0.8rem;
      cursor: pointer;
    }
    .btn-export:hover {
      background: rgba(56,189,248,0.12);
    }

    .filters {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(170px, 1fr));
      gap: 12px;
      margin-bottom: 24px;
      align-items: flex-end;
    }
    .filters-group label {
      display: block;
      font-size: 0.8rem;
      margin-bottom: 4px;
      color: #9ca3af;
    }
    .filters select {
      width: 100%;
      padding: 7px 9px;
      border-radius: 8px;
      border: 1px solid #1f2937;
      background: #020617;
      color: #e5e7eb;
      font-size: 0.9rem;
    }
    .filters select:focus {
      outline: 2px solid #38bdf8;
      outline-offset: 1px;
      border-color: transparent;
    }
    .btn-clear-filters {
      border: none;
      border-radius: 999px;
      padding: 8px 14px;
      font-size: 0.85rem;
      cursor: pointer;
      background: #111827;
      color: #e5e7eb;
      border: 1px solid #4b5563;
      width: 100%;
    }
    .btn-clear-filters:hover {
      background: #020617;
    }

    .charts {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
      gap: 16px;
      margin-bottom: 24px;
    }
    .chart-card {
      background: rgba(15,23,42,0.9);
      border-radius: 14px;
      padding: 12px 14px;
      border: 1px solid rgba(148,163,184,0.25);
    }
    .chart-title {
      font-size: 0.9rem;
      color: #e5e7eb;
      margin-bottom: 6px;
      font-weight: 500;
    }
    .chart-bar-row {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-top: 4px;
    }
    .chart-label {
      font-size: 0.8rem;
      color: #9ca3af;
      width: 40%;
      max-width: 140px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .chart-bar-wrap {
      flex: 1;
      background: #020617;
      border-radius: 999px;
      height: 8px;
      overflow: hidden;
    }
    .chart-bar {
      height: 100%;
      border-radius: 999px;
    }
    .chart-value {
      font-size: 0.75rem;
      color: #e5e7eb;
      min-width: 70px;
      text-align: right;
    }
    .chart-empty {
      font-size: 0.8rem;
      color: #6b7280;
      margin-top: 4px;
    }

    .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(340px, 1fr)); gap: 24px; }
    .card { background: #020617; border-radius: 16px; padding: 20px 20px 16px; box-shadow: 0 20px 40px rgba(15,23,42,0.6); border: 1px solid rgba(148,163,184,0.25); }
    .card.ingresos { border-top: 3px solid #22c55e; }
    .card.gastos { border-top: 3px solid #f97316; }
    .card-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; gap: 8px; }
    .card-title { font-size: 1.2rem; font-weight: 600; display:flex; flex-direction:column; gap:2px; }
    .card-subtitle { font-size: 0.75rem; color:#9ca3af; font-weight:400; }
    .total { font-size: 0.9rem; opacity: 0.9; }
    .total span { font-weight: 600; }

    form { display: grid; grid-template-columns: repeat(2, minmax(0, 1fr)); gap: 12px 16px; margin-bottom: 14px; }
    form .full { grid-column: 1 / -1; }
    label { display: block; font-size: 0.8rem; margin-bottom: 4px; color: #9ca3af; }
    input, select { width: 100%; padding: 7px 9px; border-radius: 8px; border: 1px solid #1f2937; background: #020617; color: #e5e7eb; font-size: 0.9rem; }
    input:focus, select:focus { outline: 2px solid #38bdf8; outline-offset: 1px; border-color: transparent; }

    button { border: none; border-radius: 999px; padding: 8px 14px; font-size: 0.85rem; cursor: pointer; display: inline-flex; align-items: center; gap: 4px; }
    .btn-add-mov { background: linear-gradient(135deg,#22c55e,#16a34a); color: #022c22; font-weight: 600; justify-content: center; width: 100%; }
    .gastos .btn-add-mov { background: linear-gradient(135deg,#f97316,#ea580c); color: #451a03; }
    .btn-add-cat { background: transparent; border: 1px dashed #4b5563; color: #9ca3af; padding: 6px 10px; border-radius: 999px; font-size: 0.8rem; }
    .btn-add-cat:hover { border-style: solid; color: #e5e7eb; }

    table { width: 100%; border-collapse: collapse; font-size: 0.8rem; margin-top: 6px; }
    th, td { padding: 6px 4px; text-align: left; border-bottom: 1px solid #111827; vertical-align: top; }
    th { color: #9ca3af; font-weight: 500; }
    tbody tr:nth-child(odd) { background: rgba(15,23,42,0.9); }
    .monto-pos { color: #4ade80; }
    .monto-neg { color: #fb923c; }
    .empty { font-size: 0.8rem; color: #6b7280; margin-top: 6px; text-align: center; }

    .tags {
      display:flex;
      flex-wrap:wrap;
      gap:4px;
      margin-top:2px;
    }
    .tag-pill {
      padding:2px 6px;
      border-radius:999px;
      border:1px solid #4b5563;
      font-size:0.7rem;
      color:#e5e7eb;
      background:#020617;
    }
    .acciones {
      display:flex;
      gap:4px;
      justify-content:flex-end;
    }
    .btn-accion {
      border:none;
      border-radius:999px;
      padding:3px 7px;
      font-size:0.7rem;
      cursor:pointer;
      background:#111827;
      color:#e5e7eb;
      border:1px solid #4b5563;
    }
    .btn-accion:hover {
      background:#020617;
    }
    .btn-accion.borrar {
      border-color:#b91c1c;
      color:#fecaca;
    }

    .modo-edicion {
      font-size:0.75rem;
      color:#facc15;
      margin-left:2px;
    }

    @media (max-width: 640px) {
      body { padding: 16px; }
      form { grid-template-columns: 1fr; }
      .chart-label { width: 35%; }
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>Panel de finanzas personales</h1>

    <!-- RESUMEN GLOBAL -->
    <div class="summary">
      <div class="summary-card">
        <div class="summary-label">Total ingresos</div>
        <div id="resumenIngresos" class="summary-value pos">0,00 €</div>
      </div>
      <div class="summary-card">
        <div class="summary-label">Total gastos</div>
        <div id="resumenGastos" class="summary-value neg">0,00 €</div>
      </div>
      <div class="summary-card">
        <div class="summary-label">Total neto</div>
        <div id="resumenNeto" class="summary-value neutro">0,00 €</div>
      </div>
      <div class="summary-card">
        <div class="summary-label">Saldo cuentas (actual)</div>
        <div id="resumenSaldoCuentas" class="summary-value pos">0,00 €</div>
      </div>
      <div class="summary-card">
        <div class="summary-label">% ahorro</div>
        <div id="resumenAhorro" class="summary-value pos">0,0 %</div>
        <button id="btnExportar" class="btn-export">Exportar datos (CSV)</button>
        <button id="btnGuardarBackup" class="btn-export">Guardar backup</button>
        <button id="btnCargarBackup" class="btn-export">Cargar backup</button>
      </div>
    </div>

    <!-- FILTROS -->
    <div class="filters">
      <div class="filters-group">
        <label for="filtroAnio">Año</label>
        <select id="filtroAnio">
          <option value="all">Todos los años</option>
        </select>
      </div>
      <div class="filters-group">
        <label for="filtroMes">Mes</label>
        <select id="filtroMes">
          <option value="all">Todos los meses</option>
          <option value="1">Enero</option>
          <option value="2">Febrero</option>
          <option value="3">Marzo</option>
          <option value="4">Abril</option>
          <option value="5">Mayo</option>
          <option value="6">Junio</option>
          <option value="7">Julio</option>
          <option value="8">Agosto</option>
          <option value="9">Septiembre</option>
          <option value="10">Octubre</option>
          <option value="11">Noviembre</option>
          <option value="12">Diciembre</option>
        </select>
      </div>
      <div class="filters-group">
        <label for="filtroTag">Etiqueta</label>
        <select id="filtroTag">
          <option value="all">Todas las etiquetas</option>
        </select>
      </div>
      <div class="filters-group">
        <button id="btnLimpiarFiltros" class="btn-clear-filters">Quitar filtros</button>
      </div>
    </div>

    <!-- GRÁFICOS SIMPLES -->
    <div class="charts">
      <div class="chart-card">
        <div class="chart-title">Gastos por categoría (filtrados)</div>
        <div id="graficoGastos"></div>
      </div>
      <div class="chart-card">
        <div class="chart-title">Ingresos por categoría (filtrados)</div>
        <div id="graficoIngresos"></div>
      </div>
    </div>

    <!-- CUENTAS BANCARIAS -->
    <section class="card cuentas">
      <div class="card-header">
        <div class="card-title">
          <span>Cuenta corriente / bancos</span>
          <span class="card-subtitle">Saldo total inicial + neto actual</span>
        </div>
        <div class="total">Saldo total: <span id="saldoCuentasActual">0,00 €</span></div>
      </div>

      <form id="formCuentas">
        <div class="full">
          <label for="bancoCuenta">Banco / cuenta</label>
          <input type="text" id="bancoCuenta" placeholder="Ej: Cajamar, BBVA..." required />
        </div>
        <div>
          <label for="saldoInicialCuenta">Saldo inicial (€)</label>
          <input type="number" id="saldoInicialCuenta" required min="0" step="0.01" placeholder="0,00" />
        </div>
        <div class="full">
          <button class="btn-add-mov" type="submit">Añadir cuenta</button>
        </div>
      </form>

      <div id="listaCuentasWrapper">
        <table>
          <thead>
            <tr>
              <th>Banco / cuenta</th>
              <th style="text-align:right;">Saldo inicial</th>
              <th style="text-align:right;">Acciones</th>
            </tr>
          </thead>
          <tbody id="listaCuentas"></tbody>
        </table>
        <div id="emptyCuentas" class="empty">No has añadido cuentas bancarias.</div>
      </div>
    </section>

    <!-- INVERSION INMOBILIARIA -->
    <section class="card inversion">
      <div class="card-header">
        <div class="card-title">
          <span>Inversión inmobiliaria</span>
          <span class="card-subtitle">Pisos, ROI, ROCE, rentabilidad y gastos asociados</span>
        </div>
      </div>

      <form id="formInversion">
        <div class="full">
          <label for="direccionInversion">Dirección</label>
          <input type="text" id="direccionInversion" placeholder="Calle, número, piso..." required />
        </div>
        <div>
          <label for="localidadInversion">Localidad</label>
          <input type="text" id="localidadInversion" placeholder="Ciudad / localidad" required />
        </div>
        <div>
          <label for="fechaInversion">Fecha compra</label>
          <input type="date" id="fechaInversion" />
        </div>
        <div>
          <label for="precioCompraInversion">Precio de compra (€)</label>
          <input type="number" id="precioCompraInversion" min="0" step="0.01" placeholder="0,00" />
        </div>
        <div>
          <label for="capitalInvertidoInversion">Capital invertido (€)</label>
          <input type="number" id="capitalInvertidoInversion" min="0" step="0.01" placeholder="0,00" />
        </div>
        <div>
          <label for="rentaMensualInversion">Renta mensual (€)</label>
          <input type="number" id="rentaMensualInversion" min="0" step="0.01" placeholder="0,00" />
        </div>
        <div class="full">
          <label>
            <input type="checkbox" id="ingresoConfirmadoInversion" />
            Confirmar que se ha cobrado la renta este mes
          </label>
        </div>
        <div class="full">
          <label for="pdfIngresoInversion">Comprobante de ingreso (PDF)</label>
          <input type="file" id="pdfIngresoInversion" accept="application/pdf" />
        </div>
        <div class="full">
          <button class="btn-add-mov" type="submit">Añadir inversión</button>
        </div>
      </form>

      <div id="listaInversionesWrapper">
        <table>
          <thead>
            <tr>
              <th>Dirección</th>
              <th>Localidad</th>
              <th style="text-align:right;">Renta mensual</th>
              <th style="text-align:right;">ROI (bruto)</th>
              <th style="text-align:right;">ROCE</th>
              <th style="text-align:right;">Rent. neta</th>
              <th style="text-align:center;">Ingreso confirmado</th>
              <th>PDF ingreso</th>
              <th style="text-align:right;">Acciones</th>
            </tr>
          </thead>
          <tbody id="listaInversiones"></tbody>
        </table>
        <div id="emptyInversiones" class="empty">No has añadido inversiones inmobiliarias.</div>
      </div>

      <div style="margin-top: 18px;">
        <div class="card-subtitle" style="margin-bottom:6px;">Gastos asociados al piso seleccionado</div>
        <form id="formGastoInversion">
          <div class="full">
            <label for="inversionSeleccionadaGasto">Piso</label>
            <select id="inversionSeleccionadaGasto" required></select>
          </div>
          <div>
            <label for="importeGastoInversion">Importe (€)</label>
            <input type="number" id="importeGastoInversion" min="0" step="0.01" placeholder="0,00" required />
          </div>
          <div>
            <label for="periodicidadGastoInversion">Periodicidad</label>
            <select id="periodicidadGastoInversion">
              <option value="mensual">Mensual</option>
              <option value="anual">Anual</option>
            </select>
          </div>
          <div class="full">
            <label for="tipoGastoInversion">Tipo de gasto</label>
            <input type="text" id="tipoGastoInversion" placeholder="Ej: Seguro hogar, comunidad, alquiler..." required />
          </div>
          <div class="full">
            <button class="btn-add-mov" type="submit">Añadir gasto al piso</button>
          </div>
        </form>

        <div id="listaGastosInversionWrapper">
          <table>
            <thead>
              <tr>
                <th>Tipo</th>
                <th>Periodicidad</th>
                <th style="text-align:right;">Importe</th>
                <th style="text-align:right;">Importe anual</th>
                <th style="text-align:right;">Acciones</th>
              </tr>
            </thead>
            <tbody id="listaGastosInversion"></tbody>
          </table>
          <div id="emptyGastosInversion" class="empty">Selecciona un piso para ver sus gastos.</div>
        </div>
      </div>
    </section>

    <div class="grid">
      <!-- INGRESOS -->
      <section class="card ingresos">
        <div class="card-header">
          <div class="card-title">
            <span>Ingresos</span>
            <span class="card-subtitle" id="estadoIngreso"></span>
          </div>
          <div class="total">Total: <span id="totalIngresos">0,00 €</span></div>
        </div>

        <form id="formIngresos">
          <div>
            <label for="fechaIngreso">Fecha</label>
            <input type="date" id="fechaIngreso" required />
          </div>

          <div>
            <label for="categoriaIngreso">Categoría</label>
            <div style="display:flex; gap:8px; align-items:center;">
              <select id="categoriaIngreso" required style="flex:1;">
                <option value="Alquiler">Alquiler</option>
                <option value="Nómina">Nómina</option>
                <option value="Inversiones">Inversiones</option>
              </select>
              <button type="button" class="btn-add-cat" id="btnAddCatIngreso">+ cat.</button>
            </div>
          </div>

          <div>
            <label for="montoIngreso">Monto (€)</label>
            <input type="number" id="montoIngreso" required min="0" step="0.01" placeholder="0,00" />
          </div>

          <div>
            <label for="descripcionIngreso">Descripción</label>
            <input type="text" id="descripcionIngreso" placeholder="Ej: salario, alquiler piso..." />
          </div>

          <div class="full">
            <label for="tagsIngreso">Etiquetas (separadas por comas)</label>
            <input type="text" id="tagsIngreso" placeholder="Ej: trabajo, piso, proyecto" />
          </div>

          <div class="full">
            <button class="btn-add-mov" type="submit" id="btnSubmitIngreso">Añadir ingreso</button>
          </div>
        </form>

        <div id="listaIngresosWrapper">
          <table>
            <thead>
              <tr>
                <th>Fecha</th>
                <th>Categoría</th>
                <th>Descripción / etiquetas</th>
                <th style="text-align:right;">Monto</th>
                <th style="text-align:right;">Acciones</th>
              </tr>
            </thead>
            <tbody id="listaIngresos"></tbody>
          </table>
          <div id="emptyIngresos" class="empty">Todavía no has añadido ingresos.</div>
        </div>
      </section>

      <!-- GASTOS -->
      <section class="card gastos">
        <div class="card-header">
          <div class="card-title">
            <span>Gastos</span>
            <span class="card-subtitle" id="estadoGasto"></span>
          </div>
          <div class="total">Total: <span id="totalGastos">0,00 €</span></div>
        </div>

        <form id="formGastos">
          <div>
            <label for="fechaGasto">Fecha</label>
            <input type="date" id="fechaGasto" required />
          </div>

          <div>
            <label for="categoriaGasto">Categoría</label>
            <div style="display:flex; gap:8px; align-items:center;">
              <select id="categoriaGasto" required style="flex:1;">
                <option value="Combustible">Combustible</option>
                <option value="Traspasos">Traspasos</option>
                <option value="Hipotecas">Hipotecas</option>
                <option value="Varios">Varios</option>
                <option value="Comunidad">Comunidad</option>
                <option value="Seguros">Seguros</option>
              </select>
              <button type="button" class="btn-add-cat" id="btnAddCatGasto">+ cat.</button>
            </div>
          </div>

          <div>
            <label for="montoGasto">Monto (€)</label>
            <input type="number" id="montoGasto" required min="0" step="0.01" placeholder="0,00" />
          </div>

          <div>
            <label for="descripcionGasto">Descripción</label>
            <input type="text" id="descripcionGasto" placeholder="Ej: gasolina, hipoteca..." />
          </div>

          <div class="full">
            <label for="tagsGasto">Etiquetas (separadas por comas)</label>
            <input type="text" id="tagsGasto" placeholder="Ej: coche, casa, ocio" />
          </div>

          <div class="full">
            <button class="btn-add-mov" type="submit" id="btnSubmitGasto">Añadir gasto</button>
          </div>
        </form>

        <div id="listaGastosWrapper">
          <table>
            <thead>
              <tr>
                <th>Fecha</th>
                <th>Categoría</th>
                <th>Descripción / etiquetas</th>
                <th style="text-align:right;">Monto</th>
                <th style="text-align:right;">Acciones</th>
              </tr>
            </thead>
            <tbody id="listaGastos"></tbody>
          </table>
          <div id="emptyGastos" class="empty">Todavía no has añadido gastos.</div>
        </div>
      </section>
    </div>
  </div>

  <input type="file" id="inputBackup" accept="application/json" style="display:none;" />

  <script>
    const STORAGE_KEY = "finanzas_personales_v2";

    const ingresos = [];
    const gastos = [];
    const cuentas = [];
    const inversiones = [];

    let editandoIngresoId = null;
    let editandoGastoId = null;

    const formIngresos = document.getElementById("formIngresos");
    const formGastos = document.getElementById("formGastos");
    const listaIngresos = document.getElementById("listaIngresos");
    const listaGastos = document.getElementById("listaGastos");
    const totalIngresosEl = document.getElementById("totalIngresos");
    const totalGastosEl = document.getElementById("totalGastos");
    const emptyIngresos = document.getElementById("emptyIngresos");
    const emptyGastos = document.getElementById("emptyGastos");

    const resumenIngresos = document.getElementById("resumenIngresos");
    const resumenGastos = document.getElementById("resumenGastos");
    const resumenNeto = document.getElementById("resumenNeto");
    const resumenSaldoCuentas = document.getElementById("resumenSaldoCuentas");
    const resumenAhorro = document.getElementById("resumenAhorro");
    const btnExportar = document.getElementById("btnExportar");
    const btnGuardarBackup = document.getElementById("btnGuardarBackup");
    const btnCargarBackup = document.getElementById("btnCargarBackup");

    const filtroAnio = document.getElementById("filtroAnio");
    const filtroMes = document.getElementById("filtroMes");
    const filtroTag = document.getElementById("filtroTag");
    const btnLimpiarFiltros = document.getElementById("btnLimpiarFiltros");

    const graficoGastos = document.getElementById("graficoGastos");
    const graficoIngresos = document.getElementById("graficoIngresos");

    const formCuentas = document.getElementById("formCuentas");
    const listaCuentas = document.getElementById("listaCuentas");
    const emptyCuentas = document.getElementById("emptyCuentas");
    const saldoCuentasActualEl = document.getElementById("saldoCuentasActual");

    const formInversion = document.getElementById("formInversion");
    const listaInversiones = document.getElementById("listaInversiones");
    const emptyInversiones = document.getElementById("emptyInversiones");
    const formGastoInversion = document.getElementById("formGastoInversion");
    const selectInversionGasto = document.getElementById("inversionSeleccionadaGasto");
    const listaGastosInversion = document.getElementById("listaGastosInversion");
    const emptyGastosInversion = document.getElementById("emptyGastosInversion");

    const estadoIngreso = document.getElementById("estadoIngreso");
    const estadoGasto = document.getElementById("estadoGasto");
    const btnSubmitIngreso = document.getElementById("btnSubmitIngreso");
    const btnSubmitGasto = document.getElementById("btnSubmitGasto");
    const inputBackup = document.getElementById("inputBackup");

    function generarId() {
      return Date.now().toString(36) + Math.random().toString(36).slice(2, 8);
    }

    function formatearMoneda(valor) {
      return valor.toLocaleString("es-ES", { minimumFractionDigits: 2, maximumFractionDigits: 2 }) + " €";
    }

    function parsearFecha(fechaStr) {
      if (!fechaStr) return null;
      const d = new Date(fechaStr);
      if (isNaN(d.getTime())) return null;
      return d;
    }

    function guardarEstado() {
      const selectIngreso = document.getElementById("categoriaIngreso");
      const selectGasto = document.getElementById("categoriaGasto");
      const categoriasIngresos = Array.from(selectIngreso.options).map(o => o.value);
      const categoriasGastos = Array.from(selectGasto.options).map(o => o.value);

      const data = { ingresos, gastos, categoriasIngresos, categoriasGastos, cuentas, inversiones };
      localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
    }

    function cargarEstado() {
      const texto = localStorage.getItem(STORAGE_KEY);
      if (!texto) return;
      try {
        const data = JSON.parse(texto);

        if (Array.isArray(data.categoriasIngresos)) {
          const selectIngreso = document.getElementById("categoriaIngreso");
          selectIngreso.innerHTML = "";
          data.categoriasIngresos.forEach(cat => {
            const opt = document.createElement("option");
            opt.value = cat;
            opt.textContent = cat;
            selectIngreso.appendChild(opt);
          });
        }

        if (Array.isArray(data.categoriasGastos)) {
          const selectGasto = document.getElementById("categoriaGasto");
          selectGasto.innerHTML = "";
          data.categoriasGastos.forEach(cat => {
            const opt = document.createElement("option");
            opt.value = cat;
            opt.textContent = cat;
            selectGasto.appendChild(opt);
          });
        }

        if (Array.isArray(data.ingresos)) {
          data.ingresos.forEach(i => {
            if (!i.id) i.id = generarId();
            if (!Array.isArray(i.tags)) i.tags = [];
            ingresos.push(i);
          });
        }
        if (Array.isArray(data.gastos)) {
          data.gastos.forEach(g => {
            if (!g.id) g.id = generarId();
            if (!Array.isArray(g.tags)) g.tags = [];
            gastos.push(g);
          });
        }
        if (Array.isArray(data.cuentas)) {
          data.cuentas.forEach(c => {
            if (!c.id) c.id = generarId();
            c.saldoInicial = parseFloat(c.saldoInicial || "0");
            if (isNaN(c.saldoInicial)) c.saldoInicial = 0;
            c.banco = c.banco || "";
            cuentas.push(c);
          });
        }
        if (Array.isArray(data.inversiones)) {
          data.inversiones.forEach(inv => {
            if (!inv.id) inv.id = generarId();
            inv.direccion = inv.direccion || "";
            inv.localidad = inv.localidad || "";
            inv.precioCompra = parseFloat(inv.precioCompra || "0");
            if (isNaN(inv.precioCompra)) inv.precioCompra = 0;
            inv.capitalInvertido = parseFloat(inv.capitalInvertido || "0");
            if (isNaN(inv.capitalInvertido)) inv.capitalInvertido = 0;
            inv.rentaMensual = parseFloat(inv.rentaMensual || "0");
            if (isNaN(inv.rentaMensual)) inv.rentaMensual = 0;
            inv.ingresoConfirmado = Boolean(inv.ingresoConfirmado);
            inv.pdfNombre = inv.pdfNombre || "";
            if (!Array.isArray(inv.gastos)) inv.gastos = [];
            inv.gastos.forEach(g => {
              if (!g.id) g.id = generarId();
              g.tipo = g.tipo || "";
              g.periodicidad = g.periodicidad === "anual" ? "anual" : "mensual";
              g.importe = parseFloat(g.importe || "0");
              if (isNaN(g.importe)) g.importe = 0;
            });
            inversiones.push(inv);
          });
        }
      } catch (e) {
        console.error("Error al cargar datos guardados", e);
      }
    }

    function obtenerFiltros() {
      return {
        anio: filtroAnio.value,
        mes: filtroMes.value,
        tag: filtroTag.value
      };
    }

    function filtrarMovimientos(lista) {
      const { anio, mes, tag } = obtenerFiltros();
      return lista.filter(m => {
        const d = parsearFecha(m.fecha);
        if (d) {
          const year = d.getFullYear().toString();
          const month = (d.getMonth() + 1).toString();
          if (anio !== "all" && year !== anio) return false;
          if (mes !== "all" && month !== mes) return false;
        } else {
          if (anio !== "all" || mes !== "all") return false;
        }

        if (tag !== "all") {
          const tags = Array.isArray(m.tags) ? m.tags : [];
          const hay = tags.some(t => t.toLowerCase() === tag.toLowerCase());
          if (!hay) return false;
        }
        return true;
      });
    }

    function actualizarResumen(totalIngresos, totalGastos) {
      const neto = totalIngresos - totalGastos;
      const porcentaje = totalIngresos > 0 ? (neto / totalIngresos) * 100 : 0;

      resumenIngresos.textContent = formatearMoneda(totalIngresos);
      resumenGastos.textContent = formatearMoneda(totalGastos);
      resumenNeto.textContent = formatearMoneda(neto);
      resumenAhorro.textContent =
        totalIngresos > 0
          ? porcentaje.toFixed(1).replace(".", ",") + " %"
          : "0,0 %";

      const saldoInicialCuentas = cuentas.reduce(
        (acc, c) => acc + (c.saldoInicial || 0),
        0
      );
      const saldoActualCuentas = saldoInicialCuentas + neto;
      if (resumenSaldoCuentas) {
        resumenSaldoCuentas.textContent = formatearMoneda(saldoActualCuentas);
      }
      if (saldoCuentasActualEl) {
        saldoCuentasActualEl.textContent = formatearMoneda(saldoActualCuentas);
      }
    }

    function agruparPorCategoria(lista) {
      const mapa = new Map();
      lista.forEach(m => {
        const cat = m.categoria || "Sin categoría";
        const actual = mapa.get(cat) || 0;
        mapa.set(cat, actual + (m.monto || 0));
      });
      return Array.from(mapa.entries()).sort((a, b) => b[1] - a[1]);
    }

    function calcularMetricasInversion(inv) {
      const rentaMensual = inv.rentaMensual || 0;
      const rentaAnualBruta = rentaMensual * 12;

      const gastosAnuales = (inv.gastos || []).reduce((acc, g) => {
        const importe = g.importe || 0;
        const anual = g.periodicidad === "mensual" ? importe * 12 : importe;
        return acc + anual;
      }, 0);

      const rentaAnualNeta = rentaAnualBruta - gastosAnuales;
      const precio = inv.precioCompra || 0;
      const capital = inv.capitalInvertido || 0;

      const roi = precio > 0 ? (rentaAnualBruta / precio) * 100 : 0;
      const roce = capital > 0 ? (rentaAnualNeta / capital) * 100 : 0;
      const rentNeta = precio > 0 ? (rentaAnualNeta / precio) * 100 : 0;

      return { rentaAnualBruta, gastosAnuales, rentaAnualNeta, roi, roce, rentNeta };
    }

    function actualizarGastosInversion() {
      if (!listaGastosInversion || !selectInversionGasto || !emptyGastosInversion) return;

      listaGastosInversion.innerHTML = "";
      const inversionId = selectInversionGasto.value;
      if (!inversionId) {
        emptyGastosInversion.textContent = "Selecciona un piso para ver sus gastos.";
        emptyGastosInversion.style.display = "block";
        return;
      }

      const inv = inversiones.find(i => i.id === inversionId);
      if (!inv) {
        emptyGastosInversion.textContent = "No se ha encontrado la inversión seleccionada.";
        emptyGastosInversion.style.display = "block";
        return;
      }

      const gastos = inv.gastos || [];
      if (!gastos.length) {
        emptyGastosInversion.textContent = "Este piso no tiene gastos registrados.";
        emptyGastosInversion.style.display = "block";
        return;
      }

      gastos.forEach(g => {
        const tr = document.createElement("tr");
        const anual = g.periodicidad === "mensual" ? g.importe * 12 : g.importe;
        tr.innerHTML = `
          <td>${g.tipo || "-"}</td>
          <td>${g.periodicidad === "anual" ? "Anual" : "Mensual"}</td>
          <td style="text-align:right;">${formatearMoneda(g.importe || 0)}</td>
          <td style="text-align:right;">${formatearMoneda(anual || 0)}</td>
          <td style="text-align:right;">
            <button class="btn-accion borrar borrar-gasto-inversion" data-inversion-id="${inv.id}" data-id="${g.id}">Borrar</button>
          </td>
        `;
        listaGastosInversion.appendChild(tr);
      });

      emptyGastosInversion.style.display = "none";
    }

    function renderizarGrafico(contenedor, datos, colorInicio, colorFin) {
      contenedor.innerHTML = "";
      if (!datos.length) {
        const div = document.createElement("div");
        div.className = "chart-empty";
        div.textContent = "Sin datos en el rango seleccionado.";
        contenedor.appendChild(div);
        return;
      }

      const maxValor = Math.max(...datos.map(d => d[1])) || 1;
      datos.forEach(([categoria, monto]) => {
        const fila = document.createElement("div");
        fila.className = "chart-bar-row";

        const label = document.createElement("div");
        label.className = "chart-label";
        label.textContent = categoria;

        const wrap = document.createElement("div");
        wrap.className = "chart-bar-wrap";

        const bar = document.createElement("div");
        bar.className = "chart-bar";
        bar.style.width = ((monto / maxValor) * 100).toFixed(1) + "%";
        bar.style.background = `linear-gradient(90deg, ${colorInicio}, ${colorFin})`;

        wrap.appendChild(bar);

        const valor = document.createElement("div");
        valor.className = "chart-value";
        valor.textContent = formatearMoneda(monto);

        fila.appendChild(label);
        fila.appendChild(wrap);
        fila.appendChild(valor);

        contenedor.appendChild(fila);
      });
    }

    function actualizarFiltrosOpciones() {
      const años = new Set();
      const tags = new Set();

      [...ingresos, ...gastos].forEach(m => {
        const d = parsearFecha(m.fecha);
        if (d) años.add(d.getFullYear().toString());
        (m.tags || []).forEach(t => {
          if (t) tags.add(t);
        });
      });

      const anioActual = filtroAnio.value;
      filtroAnio.innerHTML = "";
      const optAll = document.createElement("option");
      optAll.value = "all";
      optAll.textContent = "Todos los años";
      filtroAnio.appendChild(optAll);
      Array.from(años).sort().forEach(a => {
        const opt = document.createElement("option");
        opt.value = a;
        opt.textContent = a;
        filtroAnio.appendChild(opt);
      });
      if (Array.from(años).includes(anioActual)) {
        filtroAnio.value = anioActual;
      } else {
        filtroAnio.value = "all";
      }

      const tagActual = filtroTag.value;
      filtroTag.innerHTML = "";
      const optAllTag = document.createElement("option");
      optAllTag.value = "all";
      optAllTag.textContent = "Todas las etiquetas";
      filtroTag.appendChild(optAllTag);
      Array.from(tags).sort((a, b) => a.localeCompare(b, "es")).forEach(t => {
        const opt = document.createElement("option");
        opt.value = t;
        opt.textContent = t;
        filtroTag.appendChild(opt);
      });
      if (Array.from(tags).includes(tagActual)) {
        filtroTag.value = tagActual;
      } else {
        filtroTag.value = "all";
      }
    }

    function actualizarListas() {
      const ingresosFiltrados = filtrarMovimientos(ingresos);
      const gastosFiltrados = filtrarMovimientos(gastos);

      // Cuentas bancarias (no dependen de filtros)
      if (listaCuentas && emptyCuentas) {
        listaCuentas.innerHTML = "";
        cuentas.forEach((c) => {
          const tr = document.createElement("tr");
          tr.innerHTML = `
            <td>${c.banco || "-"}</td>
            <td style="text-align:right;">${formatearMoneda(c.saldoInicial || 0)}</td>
            <td style="text-align:right;">
              <button class="btn-accion borrar borrar-cuenta" data-id="${c.id}">Borrar</button>
            </td>
          `;
          listaCuentas.appendChild(tr);
        });
        emptyCuentas.style.display = cuentas.length ? "none" : "block";
      }

      // Inversiones inmobiliarias (no dependen de filtros)
      if (listaInversiones && emptyInversiones && selectInversionGasto) {
        listaInversiones.innerHTML = "";
        selectInversionGasto.innerHTML = "";

        const optDefault = document.createElement("option");
        optDefault.value = "";
        optDefault.textContent = "Selecciona un piso";
        selectInversionGasto.appendChild(optDefault);

        inversiones.forEach((inv) => {
          const tr = document.createElement("tr");
          const m = calcularMetricasInversion(inv);
          tr.innerHTML = `
            <td>${inv.direccion || "-"}</td>
            <td>${inv.localidad || "-"}</td>
            <td style="text-align:right;">${formatearMoneda(inv.rentaMensual || 0)}</td>
            <td style="text-align:right;">${m.roi.toFixed(1).replace(".", ",")} %</td>
            <td style="text-align:right;">${m.roce.toFixed(1).replace(".", ",")} %</td>
            <td style="text-align:right;">${m.rentNeta.toFixed(1).replace(".", ",")} %</td>
            <td style="text-align:center;">${inv.ingresoConfirmado ? "✔" : "—"}</td>
            <td>${inv.pdfNombre || "-"}</td>
            <td style="text-align:right;">
              <button class="btn-accion borrar borrar-inversion" data-id="${inv.id}">Borrar</button>
            </td>
          `;
          listaInversiones.appendChild(tr);

          const opt = document.createElement("option");
          opt.value = inv.id;
          opt.textContent = inv.direccion || inv.localidad || "Piso";
          selectInversionGasto.appendChild(opt);
        });

        emptyInversiones.style.display = inversiones.length ? "none" : "block";
        actualizarGastosInversion();
      }

      listaIngresos.innerHTML = "";
      let totalIngresos = 0;
      ingresosFiltrados.forEach((ing) => {
        totalIngresos += ing.monto;
        const tr = document.createElement("tr");
        const tags = Array.isArray(ing.tags) ? ing.tags : [];
        tr.innerHTML = `
          <td>${ing.fecha || "-"}</td>
          <td>${ing.categoria}</td>
          <td>
            <div>${ing.descripcion || "-"}</div>
            ${tags.length ? `<div class="tags">${tags.map(t => `<span class="tag-pill">${t}</span>`).join("")}</div>` : ""}
          </td>
          <td style="text-align:right;" class="monto-pos">${formatearMoneda(ing.monto)}</td>
          <td style="text-align:right;">
            <div class="acciones">
              <button class="btn-accion editar" data-id="${ing.id}" data-tipo="ingreso">Editar</button>
              <button class="btn-accion borrar" data-id="${ing.id}" data-tipo="ingreso">Borrar</button>
            </div>
          </td>
        `;
        listaIngresos.appendChild(tr);
      });
      totalIngresosEl.textContent = formatearMoneda(totalIngresos);
      emptyIngresos.style.display = ingresosFiltrados.length ? "none" : "block";

      listaGastos.innerHTML = "";
      let totalGastos = 0;
      gastosFiltrados.forEach((g) => {
        totalGastos += g.monto;
        const tr = document.createElement("tr");
        const tags = Array.isArray(g.tags) ? g.tags : [];
        tr.innerHTML = `
          <td>${g.fecha || "-"}</td>
          <td>${g.categoria}</td>
          <td>
            <div>${g.descripcion || "-"}</div>
            ${tags.length ? `<div class="tags">${tags.map(t => `<span class="tag-pill">${t}</span>`).join("")}</div>` : ""}
          </td>
          <td style="text-align:right;" class="monto-neg">-${formatearMoneda(g.monto)}</td>
          <td style="text-align:right;">
            <div class="acciones">
              <button class="btn-accion editar" data-id="${g.id}" data-tipo="gasto">Editar</button>
              <button class="btn-accion borrar" data-id="${g.id}" data-tipo="gasto">Borrar</button>
            </div>
          </td>
        `;
        listaGastos.appendChild(tr);
      });
      totalGastosEl.textContent = formatearMoneda(totalGastos);
      emptyGastos.style.display = gastosFiltrados.length ? "none" : "block";

      actualizarResumen(totalIngresos, totalGastos);

      const gastosPorCat = agruparPorCategoria(gastosFiltrados);
      const ingresosPorCat = agruparPorCategoria(ingresosFiltrados);
      renderizarGrafico(graficoGastos, gastosPorCat, "#f97316", "#ea580c");
      renderizarGrafico(graficoIngresos, ingresosPorCat, "#22c55e", "#16a34a");

      agregarManejadoresAcciones();
    }

    function parsearTagsDesdeInput(valor) {
      if (!valor) return [];
      return valor
        .split(",")
        .map(t => t.trim())
        .filter(Boolean);
    }

    function resetEdicion() {
      editandoIngresoId = null;
      editandoGastoId = null;
      estadoIngreso.textContent = "";
      estadoGasto.textContent = "";
      btnSubmitIngreso.textContent = "Añadir ingreso";
      btnSubmitGasto.textContent = "Añadir gasto";
      formIngresos.reset();
      formGastos.reset();
    }

    formIngresos.addEventListener("submit", (e) => {
      e.preventDefault();
      const fecha = document.getElementById("fechaIngreso").value;
      const categoria = document.getElementById("categoriaIngreso").value;
      const monto = parseFloat(document.getElementById("montoIngreso").value || "0");
      const descripcion = document.getElementById("descripcionIngreso").value.trim();
      const tags = parsearTagsDesdeInput(document.getElementById("tagsIngreso").value);

      if (!monto || monto <= 0) return;

      if (editandoIngresoId) {
        const idx = ingresos.findIndex(i => i.id === editandoIngresoId);
        if (idx !== -1) {
          ingresos[idx].fecha = fecha;
          ingresos[idx].categoria = categoria;
          ingresos[idx].monto = monto;
          ingresos[idx].descripcion = descripcion;
          ingresos[idx].tags = tags;
        }
      } else {
        ingresos.push({ id: generarId(), fecha, categoria, monto, descripcion, tags });
      }

      guardarEstado();
      actualizarFiltrosOpciones();
      actualizarListas();
      resetEdicion();
    });

    formGastos.addEventListener("submit", (e) => {
      e.preventDefault();
      const fecha = document.getElementById("fechaGasto").value;
      const categoria = document.getElementById("categoriaGasto").value;
      const monto = parseFloat(document.getElementById("montoGasto").value || "0");
      const descripcion = document.getElementById("descripcionGasto").value.trim();
      const tags = parsearTagsDesdeInput(document.getElementById("tagsGasto").value);

      if (!monto || monto <= 0) return;

      if (editandoGastoId) {
        const idx = gastos.findIndex(g => g.id === editandoGastoId);
        if (idx !== -1) {
          gastos[idx].fecha = fecha;
          gastos[idx].categoria = categoria;
          gastos[idx].monto = monto;
          gastos[idx].descripcion = descripcion;
          gastos[idx].tags = tags;
        }
      } else {
        gastos.push({ id: generarId(), fecha, categoria, monto, descripcion, tags });
      }

      guardarEstado();
      actualizarFiltrosOpciones();
      actualizarListas();
      resetEdicion();
    });

    if (formInversion) {
      formInversion.addEventListener("submit", (e) => {
        e.preventDefault();
        const direccion = document.getElementById("direccionInversion").value.trim();
        const localidad = document.getElementById("localidadInversion").value.trim();
        const fecha = document.getElementById("fechaInversion").value;
        const precioCompra = parseFloat(document.getElementById("precioCompraInversion").value || "0");
        const capitalInvertido = parseFloat(document.getElementById("capitalInvertidoInversion").value || "0");
        const rentaMensual = parseFloat(document.getElementById("rentaMensualInversion").value || "0");
        const ingresoConfirmado = document.getElementById("ingresoConfirmadoInversion").checked;
        const inputPdf = document.getElementById("pdfIngresoInversion");
        const pdfNombre =
          inputPdf && inputPdf.files && inputPdf.files[0] ? inputPdf.files[0].name : "";

        if (!direccion || !localidad) return;

        inversiones.push({
          id: generarId(),
          direccion,
          localidad,
          fecha,
          precioCompra: isNaN(precioCompra) ? 0 : precioCompra,
          capitalInvertido: isNaN(capitalInvertido) ? 0 : capitalInvertido,
          rentaMensual: isNaN(rentaMensual) ? 0 : rentaMensual,
          ingresoConfirmado,
          pdfNombre,
          gastos: []
        });

        formInversion.reset();
        if (inputPdf) inputPdf.value = "";
        guardarEstado();
        actualizarListas();
      });
    }

    if (formGastoInversion && selectInversionGasto) {
      formGastoInversion.addEventListener("submit", (e) => {
        e.preventDefault();
        const inversionId = selectInversionGasto.value;
        if (!inversionId) {
          alert("Selecciona primero un piso.");
          return;
        }
        const inv = inversiones.find(i => i.id === inversionId);
        if (!inv) return;

        const tipo = document.getElementById("tipoGastoInversion").value.trim();
        const periodicidad = document.getElementById("periodicidadGastoInversion").value;
        const importe = parseFloat(document.getElementById("importeGastoInversion").value || "0");

        if (!tipo || !importe || importe <= 0) return;

        if (!Array.isArray(inv.gastos)) inv.gastos = [];
        inv.gastos.push({
          id: generarId(),
          tipo,
          periodicidad: periodicidad === "anual" ? "anual" : "mensual",
          importe: isNaN(importe) ? 0 : importe
        });

        formGastoInversion.reset();
        guardarEstado();
        actualizarListas();
      });

      if (selectInversionGasto) {
        selectInversionGasto.addEventListener("change", () => {
          actualizarGastosInversion();
        });
      }
    }

    if (formCuentas) {
      formCuentas.addEventListener("submit", (e) => {
        e.preventDefault();
        const banco = document.getElementById("bancoCuenta").value.trim();
        const saldoInicial = parseFloat(
          document.getElementById("saldoInicialCuenta").value || "0"
        );

        if (!banco || isNaN(saldoInicial)) return;

        cuentas.push({
          id: generarId(),
          banco,
          saldoInicial
        });

        formCuentas.reset();
        guardarEstado();
        actualizarListas();
      });
    }

    function manejarNuevaCategoria(selectId) {
      const select = document.getElementById(selectId);
      const nombre = prompt("Nombre de la nueva categoría:");
      if (!nombre) return;
      const normalizado = nombre.trim();
      if (!normalizado) return;

      const existe = Array.from(select.options).some(
        (opt) => opt.text.toLowerCase() === normalizado.toLowerCase()
      );
      if (existe) {
        alert("Esa categoría ya existe.");
        return;
      }

      const opt = document.createElement("option");
      opt.value = normalizado;
      opt.textContent = normalizado;
      select.appendChild(opt);
      select.value = normalizado;

      guardarEstado();
    }

    document.getElementById("btnAddCatIngreso").addEventListener("click", () => {
      manejarNuevaCategoria("categoriaIngreso");
    });

    document.getElementById("btnAddCatGasto").addEventListener("click", () => {
      manejarNuevaCategoria("categoriaGasto");
    });

    function exportarCSV() {
      const filas = [];
      filas.push(["Tipo", "Fecha", "Categoría", "Descripción", "Etiquetas", "Monto"]);

      ingresos.forEach(i => {
        filas.push([
          "Ingreso",
          i.fecha || "",
          i.categoria || "",
          i.descripcion || "",
          (Array.isArray(i.tags) ? i.tags.join(", ") : ""),
          (i.monto ?? 0).toFixed(2).replace(".", ",")
        ]);
      });

      gastos.forEach(g => {
        filas.push([
          "Gasto",
          g.fecha || "",
          g.categoria || "",
          g.descripcion || "",
          (Array.isArray(g.tags) ? g.tags.join(", ") : ""),
          (g.monto ?? 0).toFixed(2).replace(".", ",")
        ]);
      });

      const contenido = filas
        .map(fila =>
          fila
            .map(campo => `"${String(campo).replace(/"/g, '""')}"`)
            .join(";")
        )
        .join("\n");

      const blob = new Blob([contenido], { type: "text/csv;charset=utf-8;" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = "finanzas_personales.csv";
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    }

    btnExportar.addEventListener("click", exportarCSV);

    function descargarBackup() {
      try {
        guardarEstado();
        const texto = localStorage.getItem(STORAGE_KEY) || "{}";
        const blob = new Blob([texto], { type: "application/json;charset=utf-8;" });
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        const fecha = new Date();
        const yyyy = fecha.getFullYear();
        const mm = String(fecha.getMonth() + 1).padStart(2, "0");
        const dd = String(fecha.getDate()).padStart(2, "0");
        a.href = url;
        a.download = `finanzas_backup_${yyyy}-${mm}-${dd}.json`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
      } catch (e) {
        alert("No se ha podido crear el backup.");
        console.error(e);
      }
    }

    function restaurarBackupDesdeArchivo(archivo) {
      if (!archivo) return;
      const lector = new FileReader();
      lector.onload = (evento) => {
        try {
          const texto = evento.target.result;
          const data = JSON.parse(texto);
          if (!data || typeof data !== "object") {
            throw new Error("Formato de backup no válido");
          }
          localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
          ingresos.length = 0;
          gastos.length = 0;
          cuentas.length = 0;
          inversiones.length = 0;
          cargarEstado();
          actualizarFiltrosOpciones();
          actualizarListas();
          alert("Backup restaurado correctamente.");
        } catch (e) {
          alert("No se ha podido restaurar el backup. ¿Es el archivo correcto?");
          console.error(e);
        } finally {
          if (inputBackup) inputBackup.value = "";
        }
      };
      lector.readAsText(archivo, "utf-8");
    }

    if (btnGuardarBackup) {
      btnGuardarBackup.addEventListener("click", descargarBackup);
    }

    if (btnCargarBackup && inputBackup) {
      btnCargarBackup.addEventListener("click", () => {
        inputBackup.click();
      });
      inputBackup.addEventListener("change", (e) => {
        const archivo = e.target.files && e.target.files[0];
        restaurarBackupDesdeArchivo(archivo);
      });
    }

    function agregarManejadoresAcciones() {
      document.querySelectorAll(".btn-accion.editar").forEach(btn => {
        btn.onclick = () => {
          const id = btn.getAttribute("data-id");
          const tipo = btn.getAttribute("data-tipo");
          if (tipo === "ingreso") {
            const mov = ingresos.find(i => i.id === id);
            if (!mov) return;
            document.getElementById("fechaIngreso").value = mov.fecha || "";
            document.getElementById("categoriaIngreso").value = mov.categoria || "";
            document.getElementById("montoIngreso").value = mov.monto ?? "";
            document.getElementById("descripcionIngreso").value = mov.descripcion || "";
            document.getElementById("tagsIngreso").value = (mov.tags || []).join(", ");
            editandoIngresoId = id;
            editandoGastoId = null;
            estadoIngreso.textContent = "Editando un ingreso existente.";
            estadoGasto.textContent = "";
            btnSubmitIngreso.textContent = "Guardar cambios";
            btnSubmitGasto.textContent = "Añadir gasto";
            formIngresos.scrollIntoView({ behavior: "smooth", block: "start" });
          } else {
            const mov = gastos.find(g => g.id === id);
            if (!mov) return;
            document.getElementById("fechaGasto").value = mov.fecha || "";
            document.getElementById("categoriaGasto").value = mov.categoria || "";
            document.getElementById("montoGasto").value = mov.monto ?? "";
            document.getElementById("descripcionGasto").value = mov.descripcion || "";
            document.getElementById("tagsGasto").value = (mov.tags || []).join(", ");
            editandoGastoId = id;
            editandoIngresoId = null;
            estadoGasto.textContent = "Editando un gasto existente.";
            estadoIngreso.textContent = "";
            btnSubmitGasto.textContent = "Guardar cambios";
            btnSubmitIngreso.textContent = "Añadir ingreso";
            formGastos.scrollIntoView({ behavior: "smooth", block: "start" });
          }
        };
      });

      document.querySelectorAll(".btn-accion.borrar").forEach(btn => {
        btn.onclick = () => {
          const id = btn.getAttribute("data-id");
          const tipo = btn.getAttribute("data-tipo");
          const ok = confirm("¿Seguro que quieres borrar este movimiento?");
          if (!ok) return;

          if (tipo === "ingreso") {
            const idx = ingresos.findIndex(i => i.id === id);
            if (idx !== -1) ingresos.splice(idx, 1);
          } else {
            const idx = gastos.findIndex(g => g.id === id);
            if (idx !== -1) gastos.splice(idx, 1);
          }

          guardarEstado();
          actualizarFiltrosOpciones();
          actualizarListas();
          resetEdicion();
        };
      });

      document.querySelectorAll(".borrar-cuenta").forEach(btn => {
        btn.onclick = () => {
          const id = btn.getAttribute("data-id");
          const ok = confirm("¿Seguro que quieres borrar esta cuenta bancaria?");
          if (!ok) return;

          const idx = cuentas.findIndex(c => c.id === id);
          if (idx !== -1) cuentas.splice(idx, 1);

          guardarEstado();
          actualizarListas();
        };
      });

      document.querySelectorAll(".borrar-inversion").forEach(btn => {
        btn.onclick = () => {
          const id = btn.getAttribute("data-id");
          const ok = confirm("¿Seguro que quieres borrar esta inversión inmobiliaria?");
          if (!ok) return;

          const idx = inversiones.findIndex(inv => inv.id === id);
          if (idx !== -1) inversiones.splice(idx, 1);

          guardarEstado();
          actualizarListas();
        };
      });

      document.querySelectorAll(".borrar-gasto-inversion").forEach(btn => {
        btn.onclick = () => {
          const id = btn.getAttribute("data-id");
          const inversionId = btn.getAttribute("data-inversion-id");
          const ok = confirm("¿Seguro que quieres borrar este gasto del piso?");
          if (!ok) return;

          const inv = inversiones.find(i => i.id === inversionId);
          if (!inv || !Array.isArray(inv.gastos)) return;

          const idx = inv.gastos.findIndex(g => g.id === id);
          if (idx !== -1) inv.gastos.splice(idx, 1);

          guardarEstado();
          actualizarListas();
        };
      });
    }

    filtroAnio.addEventListener("change", () => {
      actualizarListas();
    });
    filtroMes.addEventListener("change", () => {
      actualizarListas();
    });
    filtroTag.addEventListener("change", () => {
      actualizarListas();
    });

    btnLimpiarFiltros.addEventListener("click", (e) => {
      e.preventDefault();
      filtroAnio.value = "all";
      filtroMes.value = "all";
      filtroTag.value = "all";
      actualizarListas();
    });

    cargarEstado();
    actualizarFiltrosOpciones();
    actualizarListas();
  </script>
  <script>
    if ("serviceWorker" in navigator) {
      window.addEventListener("load", () => {
        navigator.serviceWorker.register("service-worker.js").catch((err) => {
          console.error("Error al registrar el service worker", err);
        });
      });
    }
  </script>
</body>
</html>
